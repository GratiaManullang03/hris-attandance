<!DOCTYPE html>
<html lang="id">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
        <meta name="theme-color" content="#10b981" />
        <title>Scan QR - HRIS Attendance</title>
        <link
            rel="manifest"
            href="data:application/json;base64,eyJuYW1lIjoiU2NhbiBRUiAtIEhSSVMiLCJzaG9ydF9uYW1lIjoiU2NhbiBRUiIsInN0YXJ0X3VybCI6Ii4iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjZmZmZmZmIiwidGhlbWVfY29sb3IiOiIjMTBiOTgxIn0=" />
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI',
                    Roboto, sans-serif;
                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                min-height: 100vh;
                padding: 20px;
            }
            .container {
                max-width: 500px;
                margin: 0 auto;
            }
            .card {
                background: white;
                border-radius: 20px;
                padding: 30px;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                margin-bottom: 20px;
            }
            h1 {
                font-size: 28px;
                margin-bottom: 25px;
                color: #333;
                text-align: center;
                font-weight: 700;
            }
            .input-group {
                margin-bottom: 20px;
            }
            .input-group label {
                display: block;
                margin-bottom: 8px;
                color: #555;
                font-size: 14px;
                font-weight: 600;
            }
            .input-group input {
                width: 100%;
                padding: 14px;
                border: 2px solid #e5e7eb;
                border-radius: 10px;
                font-size: 16px;
                transition: border-color 0.3s;
            }
            .input-group input:focus {
                outline: none;
                border-color: #10b981;
            }
            .toggle-group {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 20px;
                padding: 15px;
                background: #f9fafb;
                border-radius: 10px;
            }
            .toggle-group label {
                margin: 0;
                font-weight: 600;
                color: #374151;
            }
            .switch {
                position: relative;
                display: inline-block;
                width: 56px;
                height: 30px;
            }
            .switch input {
                opacity: 0;
                width: 0;
                height: 0;
            }
            .slider {
                position: absolute;
                cursor: pointer;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: #d1d5db;
                transition: 0.4s;
                border-radius: 30px;
            }
            .slider:before {
                position: absolute;
                content: '';
                height: 22px;
                width: 22px;
                left: 4px;
                bottom: 4px;
                background-color: white;
                transition: 0.4s;
                border-radius: 50%;
            }
            input:checked + .slider {
                background-color: #10b981;
            }
            input:checked + .slider:before {
                transform: translateX(26px);
            }
            .btn {
                width: 100%;
                padding: 16px;
                border: none;
                border-radius: 10px;
                font-size: 18px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s;
            }
            .btn-primary {
                background: #10b981;
                color: white;
            }
            .btn-primary:hover {
                background: #059669;
                transform: translateY(-2px);
                box-shadow: 0 10px 20px rgba(16, 185, 129, 0.3);
            }
            .btn-primary:disabled {
                background: #9ca3af;
                cursor: not-allowed;
                transform: none;
            }
            .btn-secondary {
                background: #ef4444;
                color: white;
                margin-top: 15px;
            }
            .btn-secondary:hover {
                background: #dc2626;
            }
            #scanner {
                width: 100%;
                border-radius: 15px;
                overflow: hidden;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
                position: relative;
                transition: border 0.3s, box-shadow 0.3s;
            }
            #scanner.captured {
                border: 5px solid #10b981;
                box-shadow: 0 0 0 5px rgba(16, 185, 129, 0.3),
                    0 10px 30px rgba(0, 0, 0, 0.2);
            }
            #scanner video {
                width: 100%;
                display: block;
            }
            #scanner canvas {
                width: 100%;
                display: block;
            }
            #snapshotOverlay {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                display: none;
                z-index: 10;
            }
            #snapshotOverlay.active {
                display: block;
            }
            .scanner-container {
                display: none;
            }
            .scanner-container.active {
                display: block;
            }
            .alert {
                padding: 15px;
                border-radius: 10px;
                margin-bottom: 20px;
                font-weight: 500;
            }
            .alert-success {
                background: #d1fae5;
                color: #065f46;
                border: 2px solid #10b981;
            }
            .alert-error {
                background: #fee2e2;
                color: #991b1b;
                border: 2px solid #ef4444;
            }
            .alert-warning {
                background: #fef3c7;
                color: #92400e;
                border: 2px solid #f59e0b;
            }
            .alert-info {
                background: #dbeafe;
                color: #1e40af;
                border: 2px solid #3b82f6;
            }
            .gps-status {
                padding: 12px;
                border-radius: 8px;
                margin-bottom: 15px;
                font-size: 13px;
                text-align: center;
            }
            .gps-status.checking {
                background: #fef3c7;
                color: #92400e;
            }
            .gps-status.valid {
                background: #d1fae5;
                color: #065f46;
            }
            .gps-status.invalid {
                background: #fee2e2;
                color: #991b1b;
            }
            .setup-form {
                display: block;
            }
            .setup-form.hidden {
                display: none;
            }
            .security-warning {
                display: none;
                background: #fef3c7;
                border: 2px solid #f59e0b;
                color: #92400e;
                padding: 12px;
                border-radius: 8px;
                margin-bottom: 15px;
                font-size: 13px;
                text-align: center;
            }
            .security-warning.active {
                display: block;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="card">
                <h1>üì± Scan QR Code</h1>

                <!-- Setup Form -->
                <div class="setup-form" id="setupForm">
                    <div class="gps-status checking" id="gpsStatus">
                        üîç Memeriksa lokasi GPS...
                    </div>

                    <p
                        style="
                            text-align: center;
                            color: #6b7280;
                            font-size: 12px;
                            margin-bottom: 15px;
                        "
                        id="backendInfo">
                        Backend:
                        <code
                            style="
                                background: #f3f4f6;
                                padding: 2px 6px;
                                border-radius: 4px;
                            "></code>
                    </p>

                    <button
                        class="btn btn-primary"
                        id="startBtn"
                        onclick="startScanner()">
                        Mulai Scanner
                    </button>
                </div>

                <!-- Scanner Area -->
                <div class="scanner-container" id="scannerContainer">
                    <div class="toggle-group">
                        <label for="torchToggle">üî¶ Flashlight</label>
                        <label class="switch">
                            <input
                                type="checkbox"
                                id="torchToggle"
                                onchange="toggleTorch()" />
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div id="scanner">
                        <canvas id="snapshotOverlay"></canvas>
                    </div>

                    <div id="scanStatus"></div>

                    <button class="btn btn-secondary" onclick="stopScanner()">
                        Stop Scanner
                    </button>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

        <script>
            // ========================================
            // CONFIG - EDIT DI SINI
            // ========================================
            const CONFIG = {
                backend:
                    'https://sona-semianimated-horridly.ngrok-free.dev/api/v1', // GANTI DENGAN URL NGROK KAMU!
                accessToken:
                    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIyIiwidXNlcm5hbWUiOiJncmF0aWEiLCJlbWFpbCI6ImZlbGl4bWFudWxsYW5nODFAZ21haWwuY29tIiwic3RhdHVzIjoiYWN0aXZlIiwiZXhwIjoxNzYxMTk1NTMzLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzYxMTkzNzMzLCJqdGkiOiI2YTA0NGNlNjNmZWMzNzQ5YmQzMTNkMmQ5MzkyMzVjZCJ9.KB3Po0IwzUqF3UbBKPLLDjsew3fbe1BH49AWFdH5EE0',
                // Set true untuk bypass GPS check (HANYA UNTUK DEVELOPMENT!)
                bypassGPS: false,
            };
            // ========================================

            let html5QrCode = null;
            let currentStream = null;
            let currentPosition = null;
            let isProcessingScan = false; // Prevent multiple scans

            // Display backend info and check GPS
            window.addEventListener('load', () => {
                document.querySelector('#backendInfo code').textContent =
                    CONFIG.backend;
                checkGPSStatus();
            });

            async function checkGPSStatus() {
                const statusEl = document.getElementById('gpsStatus');
                const startBtn = document.getElementById('startBtn');

                // Bypass GPS check untuk development
                if (CONFIG.bypassGPS) {
                    statusEl.textContent = '‚ö†Ô∏è GPS bypass aktif (DEV MODE)';
                    statusEl.className = 'gps-status valid';
                    startBtn.disabled = false;
                    // Set dummy position
                    currentPosition = {
                        coords: {
                            latitude: -6.2088,
                            longitude: 106.8456,
                            accuracy: 50,
                        },
                    };
                    return;
                }

                if (!navigator.geolocation) {
                    statusEl.textContent = '‚ùå Browser tidak mendukung GPS';
                    statusEl.className = 'gps-status invalid';
                    startBtn.disabled = true;
                    return;
                }

                try {
                    const position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(
                            resolve,
                            reject,
                            {
                                enableHighAccuracy: true,
                                timeout: 10000,
                                maximumAge: 0,
                            }
                        );
                    });

                    const isFake = detectFakeGPS(position);

                    if (isFake) {
                        statusEl.innerHTML =
                            'üö´ <strong>FAKE GPS TERDETEKSI!</strong><br>Nonaktifkan Mock Location / Fake GPS app';
                        statusEl.className = 'gps-status invalid';
                        startBtn.disabled = true;
                        startBtn.textContent = 'üö´ GPS Tidak Valid';
                        startBtn.style.background = '#dc2626';
                        startBtn.style.cursor = 'not-allowed';
                    } else {
                        currentPosition = position;
                        statusEl.textContent = `‚úÖ GPS aktif (akurasi: ${Math.round(
                            position.coords.accuracy
                        )}m)`;
                        statusEl.className = 'gps-status valid';
                        startBtn.disabled = false;
                        startBtn.textContent = 'Mulai Scanner';
                        startBtn.style.background = '';
                        startBtn.style.cursor = '';
                    }
                } catch (error) {
                    statusEl.textContent =
                        '‚ùå GPS tidak aktif. Aktifkan lokasi di pengaturan';
                    statusEl.className = 'gps-status invalid';
                    startBtn.disabled = true;
                }
            }

            function detectFakeGPS(position) {
                const coords = position.coords;
                const accuracy = coords.accuracy;
                const altitude = coords.altitude;
                const altitudeAccuracy = coords.altitudeAccuracy;
                const heading = coords.heading;
                const speed = coords.speed;

                console.log('GPS Data:', {
                    accuracy,
                    altitude,
                    altitudeAccuracy,
                    heading,
                    speed,
                    lat: coords.latitude,
                    lon: coords.longitude
                });

                // ===== MULTI-LAYER FAKE GPS DETECTION =====

                // 1. Accuracy = 0 atau terlalu presisi (fake GPS ciri khas)
                if (accuracy === 0 || accuracy < 3) {
                    console.warn('Fake GPS: Accuracy too perfect');
                    return true;
                }

                // 2. Accuracy terlalu buruk (> 100m)
                if (accuracy > 100) {
                    console.warn('Fake GPS: Accuracy too bad');
                    return true;
                }

                // 3. Mock location indicator (Android)
                if (coords.hasOwnProperty('mock') && coords.mock === true) {
                    console.warn('Fake GPS: Mock flag detected');
                    return true;
                }

                // 4. Altitude null atau 0 (fake GPS jarang set altitude)
                if (altitude === null || altitude === 0) {
                    console.warn('Fake GPS: No altitude data');
                    return true;
                }

                // 5. Heading dan speed null padahal device bergerak
                // (fake GPS statis tidak set ini)
                if (heading === null && speed === null) {
                    console.warn('Fake GPS: No heading/speed data');
                    return true;
                }

                // 6. Koordinat suspicious (0,0 atau values aneh)
                if (
                    coords.latitude === 0 && coords.longitude === 0 ||
                    Math.abs(coords.latitude) > 90 ||
                    Math.abs(coords.longitude) > 180
                ) {
                    console.warn('Fake GPS: Invalid coordinates');
                    return true;
                }

                // 7. AltitudeAccuracy null (real GPS selalu ada)
                if (altitudeAccuracy === null) {
                    console.warn('Fake GPS: No altitude accuracy');
                    return true;
                }

                return false;
            }

            async function startScanner() {
                if (!currentPosition) {
                    showAlert(
                        'GPS tidak tersedia. Refresh halaman dan coba lagi.',
                        'error'
                    );
                    return;
                }

                // Hide setup, show scanner
                document.getElementById('setupForm').classList.add('hidden');
                document
                    .getElementById('scannerContainer')
                    .classList.add('active');

                // Start camera
                html5QrCode = new Html5Qrcode('scanner');

                try {
                    await html5QrCode.start(
                        { facingMode: 'environment' },
                        {
                            fps: 30, // Increased from 10 to 30 for faster detection
                            qrbox: { width: 280, height: 280 }, // Larger scan area
                            aspectRatio: 1.0,
                        },
                        onScanSuccess,
                        onScanFailure
                    );

                    // Get video stream for torch control
                    const videoElement =
                        document.querySelector('#scanner video');
                    if (videoElement && videoElement.srcObject) {
                        currentStream = videoElement.srcObject;
                    }
                } catch (err) {
                    showAlert(`Gagal membuka kamera: ${err}`, 'error');
                    stopScanner();
                }
            }

            async function onScanSuccess(decodedText, decodedResult) {
                // Prevent multiple scans with lock
                if (isProcessingScan) {
                    return;
                }
                isProcessingScan = true;

                // INSTANT FREEZE: Capture video frame and freeze camera
                captureVideoSnapshot();

                // INSTANT FEEDBACK: Vibration (works on mobile)
                if (navigator.vibrate) {
                    navigator.vibrate([100, 50, 100]); // Double vibration pattern
                }

                // Visual feedback: Green border with glow
                const scannerEl = document.getElementById('scanner');
                scannerEl.classList.add('captured');

                showAlert('‚úÖ QR Terbaca! Memproses...', 'success');

                // Re-check GPS before submitting
                try {
                    const freshPosition = await new Promise(
                        (resolve, reject) => {
                            navigator.geolocation.getCurrentPosition(
                                resolve,
                                reject,
                                {
                                    enableHighAccuracy: true,
                                    timeout: 5000,
                                    maximumAge: 0,
                                }
                            );
                        }
                    );

                    if (detectFakeGPS(freshPosition)) {
                        showAlert(
                            '‚ö†Ô∏è Fake GPS terdeteksi saat scan! Absensi ditolak.',
                            'error'
                        );
                        resetScanner();
                        return;
                    }

                    await submitAttendance(decodedText, freshPosition);
                } catch (error) {
                    showAlert('‚ùå Gagal mendapatkan lokasi GPS', 'error');
                    resetScanner();
                }
            }

            function onScanFailure(error) {
                // Silent fail - QR not detected yet
            }

            async function submitAttendance(token, position) {
                try {
                    const response = await fetch(
                        `${CONFIG.backend}/attendance/scan`,
                        {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                Authorization: `Bearer ${CONFIG.accessToken}`,
                            },
                            body: JSON.stringify({
                                token: token,
                                ae_lat: position.coords.latitude,
                                ae_lon: position.coords.longitude,
                            }),
                        }
                    );

                    const data = await response.json();

                    if (response.ok) {
                        const status = data.data?.as_status || 'success';
                        const action =
                            status === 'checked-in' ? 'Check-In' : 'Check-Out';
                        showAlert(`‚úÖ ${action} berhasil!`, 'success');

                        // Success: wait 3 seconds then reset
                        setTimeout(() => resetScanner(), 3000);
                    } else {
                        const errorMsg =
                            data.message || data.detail || 'Scan gagal';
                        showAlert(`‚ùå ${errorMsg}`, 'error');
                        setTimeout(() => resetScanner(), 3000);
                    }
                } catch (error) {
                    showAlert(`‚ùå Network error: ${error.message}`, 'error');
                    setTimeout(() => resetScanner(), 3000);
                }
            }

            function captureVideoSnapshot() {
                try {
                    // Get video element from html5-qrcode
                    const videoEl = document.querySelector('#scanner video');
                    if (!videoEl) return;

                    // Get snapshot canvas
                    const canvas = document.getElementById('snapshotOverlay');
                    const ctx = canvas.getContext('2d');

                    // Set canvas size to match video
                    canvas.width = videoEl.videoWidth;
                    canvas.height = videoEl.videoHeight;

                    // Draw current video frame to canvas
                    ctx.drawImage(videoEl, 0, 0, canvas.width, canvas.height);

                    // Show snapshot overlay (freeze effect)
                    canvas.classList.add('active');

                    // Pause scanner after snapshot captured
                    if (html5QrCode) {
                        html5QrCode.pause();
                    }
                } catch (error) {
                    console.error('Snapshot error:', error);
                }
            }

            function resetScanner() {
                // Reset visual state
                const scannerEl = document.getElementById('scanner');
                if (scannerEl) {
                    scannerEl.classList.remove('captured');
                }

                // Hide snapshot overlay
                const canvas = document.getElementById('snapshotOverlay');
                if (canvas) {
                    canvas.classList.remove('active');
                }

                // Resume scanning
                isProcessingScan = false;
                if (html5QrCode) {
                    html5QrCode.resume();
                }
            }

            async function toggleTorch() {
                if (!currentStream) return;

                const track = currentStream.getVideoTracks()[0];
                const capabilities = track.getCapabilities();

                if (capabilities.torch) {
                    try {
                        const isEnabled =
                            document.getElementById('torchToggle').checked;
                        await track.applyConstraints({
                            advanced: [{ torch: isEnabled }],
                        });
                    } catch (err) {
                        console.error('Torch error:', err);
                        showAlert(
                            '‚ö†Ô∏è Flashlight tidak tersedia di perangkat ini',
                            'warning'
                        );
                    }
                } else {
                    showAlert(
                        '‚ö†Ô∏è Flashlight tidak didukung di perangkat ini',
                        'warning'
                    );
                    document.getElementById('torchToggle').checked = false;
                }
            }

            async function stopScanner() {
                if (html5QrCode) {
                    try {
                        await html5QrCode.stop();
                    } catch (err) {
                        console.error('Stop error:', err);
                    }
                    html5QrCode = null;
                }

                currentStream = null;
                document.getElementById('torchToggle').checked = false;

                // Reset view
                document.getElementById('setupForm').classList.remove('hidden');
                document
                    .getElementById('scannerContainer')
                    .classList.remove('active');
                document.getElementById('scanStatus').innerHTML = '';

                // Re-check GPS
                checkGPSStatus();
            }

            function showAlert(message, type) {
                const statusEl = document.getElementById('scanStatus');
                statusEl.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            }

            // Service Worker for PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register(
                    'data:text/javascript;base64,c2VsZi5hZGRFdmVudExpc3RlbmVyKCdpbnN0YWxsJywgKCkgPT4gc2VsZi5za2lwV2FpdGluZygpKTsKc2VsZi5hZGRFdmVudExpc3RlbmVyKCdhY3RpdmF0ZScsICgpID0+IHNlbGYuY2xpZW50cy5jbGFpbSgpKTs='
                );
            }

            // Prevent back button during scan
            window.addEventListener('popstate', () => {
                if (html5QrCode) {
                    const confirmStop = confirm(
                        'Scanner sedang aktif. Stop scanner?'
                    );
                    if (confirmStop) {
                        stopScanner();
                    } else {
                        window.history.pushState(
                            null,
                            '',
                            window.location.href
                        );
                    }
                }
            });
            window.history.pushState(null, '', window.location.href);
        </script>
    </body>
</html>
